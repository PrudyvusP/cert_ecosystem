# cert_ecosystem

CERT_ecosystem - это сервис учета взаимодействия с юридическими лицами (организациями).

Написан с помощью Flask с использованием [Flask-Admin](https://flask-admin.readthedocs.io/en/latest/)
в целях получения большей функциональности при минимальной вёрстке. В качестве БД используется PostgreSQL.

### Бизнес-логика

#### Организация

* Основная сущность сервиса - Организация (юридическое лицо) - Organization.
* Реквизиты организации добавляются вручную или из
  [Единого государственного реестра юридических лиц (ЕГРЮЛ)](https://egrul.nalog.ru/index.html).
* Для использования сведений из ЕГРЮЛ предусмотрено взаимодействие
  с микро-сервисом [egrul_fts_api](https://github.com/PrudyvusP/egrul_fts_api) по API (форма поиска).
* Организацию можно редактировать, но нельзя удалить.

#### Переписка

* С организацией ведется деловая переписка - Message.
* Письма могут быть входящими или исходящими.
* Одно Письмо можно отправить нескольким Организациям сразу, а у одной Организации может быть несколько Писем.
* Письма могут быть связаны друг с другом через дерево корнями вниз.
* Письма можно как редактировать, так и удалять.

#### Организационно-распорядительные документы

* Организации направляют на согласование свои организационно-распорядительные (ОР) документы - OrgAdmDoc.
* У одной Организации может быть несколько ОР Документов.
* ОР Документы хранятся в формате .pdf на файловой системе в директориях по первым двум символам UUID Организации.
* ОР Документ может быть открытым или конфиденциальным. Конфиденциальный ОР Документ в сервисе не хранятся.
* Тип ОР Документа добавляется вручную. Удаление типа ОР Документа запрещено.
* Среди ОР Документов должен быть основополагающий. В нынешней реализации сервиса под таким понимается некое соглашение.
* Если ОР документ поступает официально, то создается входящее Письмо.

#### Методические документы

* Организациям направляются методические документы (MethodicalDoc) в соответствии с их официальными запросами.
* Тип методического документа (М Документ) вместе с его файловым образом добавляет пользователь.
* Электронный образ М Документа хранится в двоичном виде в СУБД.
* М Документ может быть действующим или потерявшим актуальность.
* М Документ можно редактировать, но нельзя удалять.
* Под отправкой М Документа подразумевается создание .docx-образа официального письма и .iso-образа, содержащего архив
  с М Документами.
* При направлении М Документов по запросу Организации создаются два Письма - входящее (запрос) и исходящее (ответ).

#### Информационные ресурсы

* Организация может владеть информационными ресурсами (Resource).
* Информационные ресурсы (ИР) можно добавлять, редактировать и удалять.
* У ИР могут быть сфера(-ы) функционирования (Industry),
  задаваемые [законодательством](http://publication.pravo.gov.ru/Document/View/0001201707260023).
* *Одна организация может передавать другой Организации собственные ИР на аутсорс в части мониторинга информационной
  безопасности.* - # TODO

#### Географическая информация

* У каждой Организации есть фактический адрес расположения.
* Элементы одного ИР могут располагаться по разным адресам расположения.
* Для получения возможности выборки по географическим адресам создана сущность почтового адреса - Address.
* Адрес обязательно относится к определенному субъекту РФ (Region) и федеральному округу РФ (Okrug) соответственно.
* Создание, редактирование и удаление Адресов, Регионов и Округов запрещено.
  Географические данные Регионов и Округов заполняются с помощью миграции данных, а данные Адресов берутся из
  [Эталонного справочника почтовых индексов объектов почтовой связи АО "Почта России"](https://www.pochta.ru/support/database/ops)

### Установка

Клонировать проект:

```bash
git clone https://github.com/PrudyvusP/cert_ecosystem.git && cd "$(basename "$_" .git)"
```

Создать виртуальное окружение и активировать его:

```bash
python3 -m venv venv && source venv/bin/activate
```

Установить зависимости:

```bash
pip3 install -r requirements.txt
```

### Режимы работы

**production** - основной режим работы. DEBUG-режим выключен, в качестве БД используется PostgreSQL.  
**development** - режим работы для разработки. DEBUG-режим включен, все ошибки имеют подробное описание.
В качестве БД используется SQLite.  
**testing** - режим работы для отладки. DEBUG-режим выключен, БД - SQLite.

В случае использования режима **production** необходимо предварительно подготовить PostgreSQL.  
Запустить консольную утилиту `psql`:

```bash
sudo -iu postgres psql
```

Cоздать базу данных, создать пользователя и дать ему права:

```psql
CREATE DATABASE <db_name>;
CREATE USER <db_user> WITH PASSWORD '<db_password>';
GRANT ALL PRIVILEGES ON DATABASE <db_name> TO <db_user>;
```

### Переменные окружения

В корне основной директории проекта должен быть создан файл с названием `.env`, в котором обязательно необходимо
указать следующие переменные окружения:  
**SECRET_KEY**=<ключ для защиты от CSRF-атак (любая строка)>  
**FLASK_ENV**=<среда использования (принимает значения development/testing/production)>

#### Сведения из ЕГРЮЛ в форме поиска

Если дополнительно развернуть в докере [данный сервис](https://github.com/PrudyvusP/egrul_fts_api),
то возможно добавлять организации из ЕГРЮЛ в рабочее пространство через форму поиска.  
Для получения соответствующего функционала нужно задать следующую переменную окружения:   
**EGRUL_SERVICE_URL**=<url на котором расположен сервис с ЕГРЮЛ>

#### Отправка методических документов

Для возможности создания .docx-образа письма в адрес определенной организации необходимо
добавить в переменные окружения путь до файла-шаблона:  
**DOCX_TEMPLATE_PATH**=</path/to/file.docx>

Для сохранения результатов работы генератора письма, содержащего .docx-образ файла письма, а также
.iso-образ приложения к письму, необходимо указать путь:  
**METHOD_DOCS_PATH**=</path/to/dir/>

.docx-шаблон целесообразно хранить рядом с директорией, в которой развернут проект, а
директорию с результатами работы генератора писем лучше всего в расшаренную самбу, чтобы
пользователи сервиса могли забирать результаты работы, но при этом не могли редактировать шаблон
письма.

#### Отправка e-mail

Созданные письма, содержащие методические документы, часто остаются пользователем
незаполненными. Для осуществления контроля таких ситуаций предусмотрен механизм отправки руководителю
e-mail сообщения о таких письмах. Для использования данного функционала необходимо указать
следующие переменные окружения:  
**SMTP_PORT**=<номер smtp-порта, по умолчанию 25>  
**SMTP_HOST**=<наименование сервера исходящих сообщений, по умолчанию localhost>  
**SMTP_USER**=<логин пользователя, от которого будет отправлен e-mail>  
**SMTP_PASSWORD**=<пароль пользователя, от которого будет отправлен e-mail>  
**BOSS_EMAIL_FOR_NOTIFY**=<e-mail адреса руководителей, разделенные пробелом>

#### Режим production

Для использования возможностей сервиса в режиме **production** также нужно указать следующие
переменные окружения в файле `.env`:

**DB_NAME**=<название базы данных>  
**DB_HOST**=<доменное имя или ip-адрес, на котором вращается PostgreSQL>  
**DB_PORT**=<порт, на котором слушает запросы PostgreSQL>  
**POSTGRES_USER**=<пользователь, под которым будет работать сервис>  
**POSTGRES_PASSWORD**=<пароль, который использует пользователь для подключения>

#### Пример файла, содержащего переменные окружения

```bash
SECRET_KEY=indonesia_Xena
FLASK_ENV=production
DB_NAME=cert_db
DB_HOST=127.0.0.1
DB_PORT=5432
POSTGRES_USER=cert_db_user
POSTGRES_PASSWORD=1q2w3e4r
EGRUL_SERVICE_URL=http://localhost:28961
METHOD_DOCS_PATH=/home/samba/method_docs/
DOCX_TEMPLATE_PATH=/home/debian/doc.docx
SMTP_HOST=mail.local
SMTP_PORT=25
SMTP_USER=user@mail.local
SMTP_PASSWORD=4r3e2w1q
BOSS_EMAIL_FOR_NOTIFY="boss@mail.local hugoboss@mail.local"
```

### Настройка

Для создания схемы БД необходимо применить подготовленные миграции:

```bash
flask db upgrade
```

#### Management-команды

##### flask index

Команда `flask index <path_to_file>` обрабатывает информацию о почтовых индексах.
На вход хочет получать файл вида ```PIndx*.dbf```,
который загружается [отсюда](https://www.pochta.ru/support/database/ops).

```bash
flask index -f <path_to_file> check
flask index -f <path_to_file> update
```

`check` - сравнивает данные в БД с файлом `<path_to_file>`;  
`update` - заполняет БД актуальными данными из `<path_to_file>`.

Таким образом, для первого использования необходимо выполнить команду `flask index <path_to_file> update`.

В консоли `psql` можно проверить результат применения миграций и залива сведений о регионах, например:

```psql
\c <db_name>;
SELECT COUNT(*) FROM regions;
```

Результатом SQL-запроса выше может быть следующая строка:

```psql
 count 
-------
    86
(1 row)
```

Если count > 0, то миграции успешно применены, а сведения корректно залиты.

##### flask notify

Команда `flask notify` достает из БД информацию об имеющихся в работе письмах,
содержащих методические рекомендации, но не имеющих реквизитов, и отправляет о них
информацию на почты руководителей.  
Рекомендуется использовать вместе с `cron`.
Для этого необходимо добавить строку следующего содержания в файл `/etc/crontab`:  
`00 12 * * tue,fri debian cd /home/debian/cert_ecosystem && venv/bin/flask notify`

При данной конфигурации команда `flask notify` будет выполняться
каждые вторник и пятницу в 12:00.

### Развертывание

Один из вариантов развертывания сервиса - это создание соответствующей службы.
Представим, что сервис должен вращаться от имени пользователя *debian* в домашней
директории */home/debian/* и быть доступным по адресу *http://localhost:8000*.
В таком случае необходимо создать файл `/etc/systemd/system/cert_ecosystem.service`
как минимум следующего содержания:

```bash
[Unit]
Description=Cert Ecosystem Web Service
After=network.target
 
[Service]
User=debian
WorkingDirectory=/home/debian/cert_ecosystem/
ExecStart=/home/debian/cert_ecosystem/venv/bin/gunicorn -b localhost:8000 -w 3 app:app --access-logfile -
Restart=always

[Install]
WantedBy=multi-user.target
```

После заполнения файла `/etc/systemd/system/cert_ecosystem.service`
нужно создать символическую ссылку на сервис для автоматического поднятия службы,
перезапустить конфигуратор служб и запустить *cert_ecosystem*:

```bash
sudo systemctl enable cert_ecosystem.service
sudo systemctl daemon-reload
sudo systemctl start cert_ecosystem
```

Убедиться в том, что сервис работает корректно можно переходом в браузере на адрес
http://localhost:8000.

### Дополнительно

В качестве статического сервера можно и нужно использовать либо Nginx, либо Apache.
Данный сервис используется разработчиком в паре с Apache.

### Трудности бытия

Проблема:
*в pg_hba.conf нет записи для компьютера "<db_host>", пользователя "<db_user>",
базы "<db_name>", SSL выкл.*  
Решение:  
Открыть конфиг PostgreSQL:

```bash
sudo vim /etc/postgresql/12/main/pg_hba.conf
```

Добавить строчку вида: `host  <db_name>  <db_user>  <db_host>:<db_port>   md5`

Перезапустить PostgreSQL:

```bash
sudo serivce postgresql reload
```

### Резервное копирование сведений

Для создания резервной копии БД можно использовать команду `pg_dump` в паре с `cron`.

Для формирования дампа из PostgreSQL может использоваться команда:

```bash
pg_dump -U <POSTGRES_USER> -h <DB_HOST> -p <DB_PORT> -d <DB_NAME> > <dump_name>.sql
```

Подробнее о бэкапе можно почитать [тут](https://habr.com/ru/post/595641/).

Для резервного копирования файлов организации может использоваться команда:

```bash
tar -zcf <path_to_dir_for_backups>.cert_org_files_backup-$(date +"%d-%m-%Y_%H-%M").tar.gz -C <path_to_dir_with_service>/cert_ecosystem/organizations/static/organizations .  
```

### Демонстрация бизнес-логики

Для быстрого развертывания предусмотрен скрипт **setup.sh**, который создаст виртуальное
окружение, загрузит необходимые зависимости, добавит необходимые переменные окружения (режим **testing**),
сделает миграции БД (дополнительно добавив сведения о регионах и округах РФ), а также
зальет тестовые данные для демонстрации логики работы сервиса:

```bash
bash setup.sh
```